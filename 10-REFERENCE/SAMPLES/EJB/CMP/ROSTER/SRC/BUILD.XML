<?xml version="1.0" encoding="iso-8859-1"?>

<!DOCTYPE project [ <!ENTITY include SYSTEM "../../../../common.xml"> ]>

  <!-- ======================================================= -->
  <!--  Sun ONE Application Server Sample Application build xml -->
  <!-- ======================================================= -->

  <project name="cmproster" default="core" basedir=".">

  <!-- ======================================================= -->
  <!--			 App name-dependent settings.				   -->
  <!-- ======================================================= -->

  <property name="appname" value="cmp-roster"/>
  <property name="sample.home" value="../../../../"/>
  <property name="sample.name" value="CmpRosterApp"/>

  <!-- ======================================================= -->
  <!--			 Package directory structures of interest.	   -->
  <!-- ======================================================= -->

  <property name="app.pkg" value="samples/ejb/cmp/roster/client"/>
  <property name="jar.pkg" value="samples/ejb/cmp/roster"/>
 
  <!-- ======================================================= -->
  <!--			Java Doc properties .					       -->
  <!-- ======================================================= -->
  <property name="javadoc.pkgnames" value="samples.ejb.cmp.roster.*" />

  <!-- ======================================================= -->
  <!--				Include common.xml					       -->
  <!-- ======================================================= -->
 
  &include;
	
  <!-- ======================================================= -->
  <!--		Tagets to build and deploy sample application      -->
  <!-- ======================================================= -->

  <target name="clean" depends="clean_common"/>
  <target name="init" depends="init_common"/>
  <target name="compile" depends="compile_common" />
  <target name="javadocs" depends="javadocs_common" />
  <target name="reconfig" depends="reconfig_common" />
  <target name="deploy" depends="deploy_common,setup"/>
  <target name="undeploy" depends="undeploy_common,unsetup"/>
  <target name="verify" depends="verify_common"/>
  <target name="sql" depends="sql_common"/>

  <target name="jar" depends="init,create_team_ejbjar,create_roster_ejbjar"/>
  <target name="clientjar" depends="init,clientjar_common"/>
  <target name="ear" depends="init,jar,clientjar,create_ear"/>
  <target name="core" depends="compile,ear" />
  <target name="all" depends="core,javadocs,verify,deploy"/>

  <!-- ======================================================= -->
  <!-- Assemble EJB JAR module.                                -->
  <!-- ======================================================= -->
  <property name="assemble.teamejbjar" value="${assemble}/teamjar"/>
  <property name="assemble.rosterejbjar" value="${assemble}/rosterjar"/>
  <property name="teamejbjar" value="cmp-roster-teamEjb.jar"/>
  <property name="rosterejbjar" value="cmp-rosterEjb.jar"/>
  <target name="clean_team_ejbjar">
    <delete dir="${assemble.teamejbjar}"/>
  </target>

  <target name="create_team_ejbjar" depends="clean_team_ejbjar">
    <mkdir dir="${assemble.teamejbjar}"/>
    <copy todir="${assemble.teamejbjar}/${jar.pkg}">
      <fileset dir="${build.classesdir}/${jar.pkg}/" includes="**/*.class" excludes="**/Roster*, **/servlet/"/>
    </copy>
    <mkdir dir="${assemble.teamejbjar}/META-INF"/>
    <copy file="ejb-jar-team.xml" tofile="${assemble.teamejbjar}/META-INF/ejb-jar.xml" />
    <copy file="sun-ejb-jar-team.xml" tofile="${assemble.teamejbjar}/META-INF/sun-ejb-jar.xml" />
    <copy file="sun-cmp-mappings.xml" tofile="${assemble.teamejbjar}/META-INF/sun-cmp-mappings.xml" />
    <copy file="sql/RosterSchema.dbschema" tofile="${assemble.teamejbjar}/RosterSchema.dbschema" />
    <jar jarfile="../${teamejbjar}"
       basedir="${assemble.teamejbjar}" />
    <move file="../${teamejbjar}" todir="${assemble.teamejbjar}"/>
  </target>

  <target name="clean_roster_ejbjar">
    <delete dir="${assemble.teamejbjar}"/>
  </target>

  <target name="create_roster_ejbjar" depends="clean_team_ejbjar">
    <mkdir dir="${assemble.rosterejbjar}"/>
    <copy todir="${assemble.rosterejbjar}/${jar.pkg}">
      <fileset dir="${build.classesdir}/${jar.pkg}/" includes="**/*.class" excludes="**/LeagueBean.class,**/PlayerBean.class, **/TeamBean.class, **/servlet/, **/client/"/>
    </copy>
    <mkdir dir="${assemble.rosterejbjar}/META-INF"/>
    <copy file="ejb-jar-roster.xml" tofile="${assemble.rosterejbjar}/META-INF/ejb-jar.xml" />
    <copy file="sun-ejb-jar-roster.xml" tofile="${assemble.rosterejbjar}/META-INF/sun-ejb-jar.xml" />
    <jar jarfile="../${rosterejbjar}"
       basedir="${assemble.rosterejbjar}" />
    <move file="../${rosterejbjar}" todir="${assemble.rosterejbjar}"/>
  </target>

  <target name="create_ear" depends="clean_ear_common,jar,mkdir_ear,copy_clientjar">
    <copy file="${assemble.rosterejbjar}/${rosterejbjar}" todir="${assemble.ear}"/>
    <copy file="${assemble.teamejbjar}/${teamejbjar}" todir="${assemble.ear}"/>
    <copy todir="${assemble.ear}/META-INF/">
      <fileset dir="." includes="${earDD}"/>
    </copy>
    <jar jarfile="${assemble.ear}/${ear}"
       basedir="${assemble.ear}" excludes="**/*.ear"/>
    <delete file="${assemble.ear}/${teamejbjar}" />
    <delete file="${assemble.ear}/${rosterejbjar}" />
    <delete file="${assemble.ear}/${clientjar}" />
    <delete file="../${clientjar}" />
    <copy file="${assemble.ear}/${ear}" tofile="../${ear}"/>
  </target>

  <!-- ============================================================== -->
  <!--           Resource specific properties.                        -->
  <!-- ============================================================== -->
  <property name="conpool.name"       value="cmp-roster-pool" />
  <property name="jdbc.resource.name" value="jdbc/cmp-roster" />
  <property name="pm.resource.name"   value="jdo/cmp-roster" />
  <property name="pm.factory.class"
            value="com.sun.jdo.spi.persistence.support.sqlstore.impl.PersistenceManagerFactoryImpl" />

  <property name="db.user"  value="cmp"/>
  <property name="db.pwd"   value="cmp"/>
  <property name="ds.class" value="com.pointbase.jdbc.jdbcDataSource" />
  <property name="db.file"  value="sql/RosterApp.sql"/>
  <property name="url.prop" value="DatabaseName" />

  <!-- ============================================================== -->
  <!--           Tagets to build and deploy sample application.       -->
  <!-- ============================================================== -->

  <target name="create-jdbc-connection-pool">
    <property name="db.host"  value="localhost"/>
    <property name="db.port"  value="9092"/>
    <property name="db.sid"   value="sun-appserv-samples"/>
    <property name="db.url"   value="jdbc:pointbase://${db.host}:${db.port}\/${db.sid}" />
    <antcall target="admin_command_common">
      <param name="admin.command"
        value="create-jdbc-connection-pool ${conpool.name}
          --datasourceclassname ${ds.class}
          --instance ${sunone.instance}" />
    </antcall>
    <antcall target="admin_command_common">
      <param name="admin.command"
        value="set ${sunone.instance}.jdbc-connection-pool.${conpool.name}.property.${url.prop}=${db.url}" />
    </antcall>
    <antcall target="admin_command_common">
      <param name="admin.command"
        value="set ${sunone.instance}.jdbc-connection-pool.${conpool.name}.property.User=${db.user}" />
    </antcall>
    <antcall target="admin_command_common">
      <param name="admin.command"
        value="set ${sunone.instance}.jdbc-connection-pool.${conpool.name}.property.Password=${db.pwd}" />
    </antcall>
  </target>

  <target name="create-jdbc-resource">
    <antcall target="admin_command_common">
      <param name="admin.command"
        value="create-jdbc-resource ${jdbc.resource.name}
         --connectionpoolid ${conpool.name}
         --instance ${sunone.instance}" />
    </antcall>
  </target>

  <target name="create-persistence-resource">
    <antcall target="admin_command_common">
      <param name="admin.command"
        value="create-persistence-resource ${pm.resource.name}
          --instance ${sunone.instance}" />
    </antcall>
    <antcall target="admin_command_common">
      <param name="admin.command" value="set
        ${sunone.instance}.persistence-manager-factory-resource.${pm.resource.name}.factoryClass=${pm.factory.class}"/>
    </antcall>
    <antcall target="admin_command_common">
      <param name="admin.command" value="set
        ${sunone.instance}.persistence-manager-factory-resource.${pm.resource.name}.JdbcResourceJndiName=${jdbc.resource.name}"/>
    </antcall>
  </target>

  <target name="delete-jdbc-connection-pool">
    <antcall target="admin_command_common">
      <param name="admin.command"
        value="delete-jdbc-connection-pool ${conpool.name}
          --instance ${sunone.instance}" />
    </antcall>
  </target>

  <target name="delete-jdbc-resource">
    <antcall target="admin_command_common">
      <param name="admin.command"
        value="delete-jdbc-resource ${jdbc.resource.name}
          --instance ${sunone.instance}" />
    </antcall>
  </target>

  <target name="delete-persistence-resource">
    <antcall target="admin_command_common">
      <param name="admin.command"
        value="delete-persistence-resource ${pm.resource.name}
          --instance ${sunone.instance}" />
    </antcall>
  </target>

  <target name="setup" depends="setup_env">
    <antcall target="create-jdbc-connection-pool"/>
    <antcall target="create-jdbc-resource"/>
    <antcall target="create-persistence-resource"/>
    <antcall target="reconfig"/>
  </target>

  <target name="unsetup" depends="delete-persistence-resource,
    delete-jdbc-resource, delete-jdbc-connection-pool, reconfig"/>

</project>
